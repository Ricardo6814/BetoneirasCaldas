<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betoneira Caldas - Sistema de Aluguel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a3a4a;
            --primary-light: #234d61;
            --accent: #f0a500;
            --accent-hover: #d4920a;
            --success: #17a86e;
            --danger: #e03c3c;
            --warning: #f0a500;
            --info: #3b82f6;
            --surface: #ffffff;
            --surface-2: #f7f8fa;
            --border: #e5e9ed;
            --text: #1c2b36;
            --text-muted: #6b7f8c;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background-color: var(--surface-2);
            color: var(--text);
            margin: 0;
        }

        /* ── SIDEBAR ── */
        .sidebar {
            position: fixed;
            top: 0; left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 100;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        }

        .sidebar-brand {
            padding: 28px 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .sidebar-brand-icon {
            width: 44px; height: 44px;
            background: var(--accent);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem;
            color: var(--primary);
            margin-bottom: 12px;
            font-weight: 700;
        }

        .sidebar-brand h5 {
            color: #fff;
            font-weight: 700;
            font-size: 1.05rem;
            margin: 0 0 2px;
            letter-spacing: -0.3px;
        }

        .sidebar-brand p {
            color: rgba(255,255,255,0.45);
            font-size: 0.72rem;
            margin: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }

        .sidebar-section-label {
            color: rgba(255,255,255,0.3);
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            padding: 4px 12px 8px;
            margin-top: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255,255,255,0.6);
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 2px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.18s ease;
            text-decoration: none;
        }

        .nav-link i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }

        .nav-link.active {
            background: var(--accent);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-link.active i { color: var(--primary); }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.06);
        }

        .user-avatar {
            width: 34px; height: 34px;
            background: var(--accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
        }

        .user-name { color: #fff; font-size: 0.82rem; font-weight: 600; }
        .user-role { color: rgba(255,255,255,0.4); font-size: 0.7rem; }

        /* ── MAIN ── */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .topbar {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 14px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .topbar-actions { display: flex; align-items: center; gap: 10px; }

        .page-content { padding: 28px 32px; }

        /* ── CARDS ── */
        .card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 14px 14px 0 0 !important;
        }

        .card-header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header-title i { color: var(--accent); font-size: 1rem; }

        .card-body { padding: 20px; }

        /* ── STAT CARDS ── */
        .stat-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 22px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .stat-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.35rem;
            flex-shrink: 0;
        }

        .stat-icon.blue   { background: #e8f0fe; color: var(--info); }
        .stat-icon.green  { background: #e6f7f0; color: var(--success); }
        .stat-icon.orange { background: #fff3e0; color: var(--accent); }
        .stat-icon.red    { background: #fdecea; color: var(--danger); }

        .stat-body { flex: 1; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--text); line-height: 1; font-family: 'DM Mono', monospace; }

        /* ── BUTTONS ── */
        .btn {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.82rem;
            border-radius: 8px;
            padding: 7px 16px;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .btn-primary   { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-light); color: #fff; }
        .btn-accent    { background: var(--accent); color: var(--primary); }
        .btn-accent:hover { background: var(--accent-hover); color: var(--primary); }
        .btn-success   { background: var(--success); color: #fff; }
        .btn-success:hover { background: #129960; color: #fff; }
        .btn-danger    { background: var(--danger); color: #fff; }
        .btn-danger:hover { background: #c42e2e; color: #fff; }
        .btn-secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); color: var(--text); }
        .btn-info      { background: var(--info); color: #fff; }
        .btn-info:hover { background: #2563eb; color: #fff; }

        /* Icon-only action buttons */
        .btn-icon {
            width: 32px; height: 32px;
            padding: 0;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.82rem;
            border: 1px solid transparent;
            transition: all 0.15s;
            cursor: pointer;
        }

        .btn-icon-edit   { background: #e8f0fe; color: var(--info); border-color: #c7d9fc; }
        .btn-icon-edit:hover { background: var(--info); color: #fff; border-color: var(--info); }
        .btn-icon-delete { background: #fdecea; color: var(--danger); border-color: #f9c6c6; }
        .btn-icon-delete:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn-icon-pay    { background: #e6f7f0; color: var(--success); border-color: #b7e8d3; }
        .btn-icon-pay:hover { background: var(--success); color: #fff; border-color: var(--success); }
        .btn-icon-return { background: #fff3e0; color: var(--accent); border-color: #fbd99a; }
        .btn-icon-return:hover { background: var(--accent); color: var(--primary); border-color: var(--accent); }

        .action-group { display: flex; gap: 5px; align-items: center; }

        /* ── TABLES ── */
        .table { margin: 0; }
        .table thead th {
            background: var(--surface-2);
            color: var(--text-muted);
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
        }

        .table tbody td {
            padding: 12px 16px;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .table tbody tr:last-child td { border-bottom: none; }
        .table-hover tbody tr:hover td { background: var(--surface-2); }

        /* ── BADGES ── */
        .badge {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            letter-spacing: 0.3px;
        }

        .badge-paid     { background: #e6f7f0; color: #0d8a56; }
        .badge-unpaid   { background: #fdecea; color: #c42e2e; }
        .badge-returned { background: #e6f7f0; color: #0d8a56; }
        .badge-rented   { background: #fff3e0; color: #c47800; }

        /* ── PAGE HEADER ── */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .page-header-left h2 {
            font-size: 1.35rem;
            font-weight: 700;
            margin: 0 0 2px;
        }

        .page-header-left p {
            color: var(--text-muted);
            font-size: 0.82rem;
            margin: 0;
        }

        /* ── MODALS ── */
        .modal-content { border-radius: 16px; border: 1px solid var(--border); }
        .modal-header {
            background: var(--primary);
            color: #fff;
            border-radius: 16px 16px 0 0;
            padding: 18px 24px;
            border-bottom: none;
        }
        .modal-title { font-size: 0.95rem; font-weight: 600; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); }

        .form-label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .form-control, .form-select {
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            padding: 9px 12px;
            font-family: 'DM Sans', sans-serif;
            transition: border 0.15s;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(240,165,0,0.15);
        }

        .value-highlight {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            text-align: center;
        }
        .value-highlight span { font-size: 1.4rem; font-weight: 700; color: var(--success); font-family: 'DM Mono', monospace; }
        .value-highlight p { font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 2px 0 0; font-weight: 600; }

        /* ── EMPTY STATE ── */
        .empty-state {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
        }
        .empty-state i { font-size: 2.5rem; opacity: 0.3; margin-bottom: 12px; display: block; }
        .empty-state p { font-size: 0.875rem; margin: 0; }

        /* ── TOAST ── */
        .toast-custom {
            position: fixed;
            bottom: 24px; right: 24px;
            background: var(--primary);
            color: #fff;
            border-radius: 10px;
            padding: 14px 20px;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            animation: slideUp 0.3s ease;
        }
        .toast-custom.success::before { content: '✓'; background: var(--success); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; }
        .toast-custom.danger { background: var(--danger); }

        @keyframes slideUp {
            from { transform: translateY(12px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }

        /* ── RESPONSIVE ── */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-wrapper { margin-left: 0; }
        }

        /* Sections hidden */
        .section-hidden { display: none; }
    </style>
</head>
<body>

<!-- ═══════════════ SIDEBAR ═══════════════ -->
<aside class="sidebar">
    <div class="sidebar-brand">
        <div class="sidebar-brand-icon"><i class="bi bi-hammer"></i></div>
        <h5>Betoneira Cal</h5>
        <p>Sistema de Aluguel</p>
    </div>

    <nav class="sidebar-nav">
        <div class="sidebar-section-label">Principal</div>
        <a class="nav-link active" href="#" id="dashboard-link">
            <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a class="nav-link" href="#" id="products-link">
            <i class="bi bi-tools"></i> Produtos
        </a>

        <div class="sidebar-section-label" style="margin-top:12px;">Operações</div>
        <a class="nav-link" href="#" id="rentals-link">
            <i class="bi bi-cart-check"></i> Aluguéis
        </a>
        <a class="nav-link" href="#" id="returns-link">
            <i class="bi bi-arrow-return-left"></i> Devoluções
        </a>
        <a class="nav-link" href="#" id="debts-link">
            <i class="bi bi-credit-card"></i> Dívidas
        </a>

        <div class="sidebar-section-label" style="margin-top:12px;">Análise</div>
        <a class="nav-link" href="#" id="reports-link">
            <i class="bi bi-graph-up"></i> Relatórios
        </a>
    </nav>

    <div class="sidebar-footer">
        <div class="sidebar-user">
            <div class="user-avatar">BP</div>
            <div>
                <div class="user-name">Administrador</div>
                <div class="user-role">Gestão de Aluguéis</div>
            </div>
        </div>
    </div>
</aside>

<!-- ═══════════════ MAIN ═══════════════ -->
<div class="main-wrapper">
    <!-- TOPBAR -->
    <header class="topbar">
        <span class="topbar-title" id="topbar-title">Dashboard</span>
        <div class="topbar-actions">
            <span style="font-size:0.78rem; color:var(--text-muted);" id="topbar-date"></span>
        </div>
    </header>

    <main class="page-content">

        <!-- ── DASHBOARD ── -->
        <div id="dashboard-section">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="bi bi-tools"></i></div>
                        <div class="stat-body">
                            <div class="stat-label">Total de Produtos</div>
                            <div class="stat-value" id="total-products">0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="bi bi-cash-coin"></i></div>
                        <div class="stat-body">
                            <div class="stat-label">Receita Total</div>
                            <div class="stat-value" id="total-revenue" style="font-size:1.15rem;">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-icon red"><i class="bi bi-credit-card"></i></div>
                        <div class="stat-body">
                            <div class="stat-label">Total de Dívidas</div>
                            <div class="stat-value" id="total-debts" style="font-size:1.15rem;">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-header-title"><i class="bi bi-cart-check"></i> Aluguéis Recentes</span>
                            <button class="btn btn-secondary btn-sm" onclick="showSection('rentals')"><i class="bi bi-eye"></i> Ver todos</button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-hover" id="recent-rentals">
                                <thead><tr><th>Cliente</th><th>Produto</th><th>Status</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-header-title"><i class="bi bi-credit-card"></i> Dívidas Recentes</span>
                            <button class="btn btn-secondary btn-sm" onclick="showSection('debts')"><i class="bi bi-eye"></i> Ver todas</button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-hover" id="recent-debts">
                                <thead><tr><th>Pessoa</th><th>Valor</th><th>Status</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── PRODUCTS ── -->
        <div id="products-section" class="section-hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Produtos</h2>
                    <p>Gerencie seu inventário de equipamentos</p>
                </div>
                <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="bi bi-plus-circle"></i> Novo Produto
                </button>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover" id="products-table">
                        <thead><tr><th>Nome</th><th>Quantidade</th><th>Valor Diária</th><th>Valor Total Estoque</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ── RENTALS ── -->
        <div id="rentals-section" class="section-hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Aluguéis</h2>
                    <p>Histórico completo de locações</p>
                </div>
                <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#addRentalModal">
                    <i class="bi bi-plus-circle"></i> Novo Aluguel
                </button>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover" id="rentals-table">
                        <thead><tr><th>Cliente</th><th>Produto</th><th>Data</th><th>Dias</th><th>Total</th><th>Pagamento</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ── RETURNS ── -->
        <div id="returns-section" class="section-hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Devoluções</h2>
                    <p>Aluguéis ativos aguardando devolução</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover" id="active-rentals">
                        <thead><tr><th>Cliente</th><th>Produto</th><th>Data Aluguel</th><th>Dias</th><th>Total</th><th>Pagamento</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ── DEBTS ── -->
        <div id="debts-section" class="section-hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Dívidas</h2>
                    <p>Controle de recebimentos e pendências</p>
                </div>
                <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#addDebtModal">
                    <i class="bi bi-plus-circle"></i> Nova Dívida
                </button>
            </div>
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover" id="debts-table">
                        <thead><tr><th>Pessoa</th><th>Descrição</th><th>Data</th><th>Total</th><th>Pago</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ── REPORTS ── -->
        <div id="reports-section" class="section-hidden">
            <div class="page-header">
                <div class="page-header-left">
                    <h2>Relatórios Financeiros</h2>
                    <p>Visão consolidada das operações</p>
                </div>
                <button class="btn btn-accent" id="generate-report">
                    <i class="bi bi-file-earmark-arrow-down"></i> Gerar Relatório
                </button>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center py-4">
                            <div style="color:var(--text-muted);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Total Aluguéis</div>
                            <div style="font-size:1.4rem;font-weight:700;font-family:'DM Mono';color:var(--primary);" id="total-rentals">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center py-4">
                            <div style="color:var(--text-muted);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Recebidos</div>
                            <div style="font-size:1.4rem;font-weight:700;font-family:'DM Mono';color:var(--success);" id="paid-rentals">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center py-4">
                            <div style="color:var(--text-muted);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Em Aberto</div>
                            <div style="font-size:1.4rem;font-weight:700;font-family:'DM Mono';color:var(--danger);" id="unpaid-rentals">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card" style="border-color:var(--success);background:linear-gradient(135deg,#e6f7f0,#fff);">
                        <div class="card-body text-center py-4">
                            <div style="color:var(--success);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Saldo Final</div>
                            <div style="font-size:1.4rem;font-weight:700;font-family:'DM Mono';color:var(--success);" id="final-balance">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><span class="card-header-title"><i class="bi bi-cart-check"></i> Resumo de Aluguéis</span></div>
                        <div class="card-body"><canvas id="rentalsChart" height="220"></canvas></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header"><span class="card-header-title"><i class="bi bi-credit-card"></i> Resumo de Dívidas</span></div>
                        <div class="card-body">
                            <canvas id="debtsChart" height="220"></canvas>
                            <div class="mt-3" style="font-size:0.82rem;color:var(--text-muted);">
                                <div class="d-flex justify-content-between mb-1"><span>Total de Dívidas</span><strong id="total-debts-report">R$ 0,00</strong></div>
                                <div class="d-flex justify-content-between mb-1"><span>Pagas</span><strong id="paid-debts" style="color:var(--success);">R$ 0,00</strong></div>
                                <div class="d-flex justify-content-between"><span>Em Aberto</span><strong id="unpaid-debts" style="color:var(--danger);">R$ 0,00</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- ═══════════════ MODALS ═══════════════ -->

<!-- Add Product -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-tools me-2"></i>Adicionar Produto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="mb-3">
                        <label class="form-label">Nome do Produto</label>
                        <input type="text" class="form-control" id="product-name" placeholder="Ex: Betoneira 400L" required>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">Quantidade Disponível</label>
                            <input type="number" class="form-control" id="product-quantity" min="0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Valor da Diária (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="product-daily-rate" min="0" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="save-product"><i class="bi bi-check2"></i> Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Rental -->
<div class="modal fade" id="addRentalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cart-plus me-2"></i>Novo Aluguel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rental-form">
                    <div class="mb-3">
                        <label class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="rental-client" placeholder="Nome do cliente" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Produto</label>
                        <select class="form-select" id="rental-product" required>
                            <option value="">Selecione um produto</option>
                        </select>
                        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:5px;" id="product-info">Disponível: — | Diária: —</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label">Dias de Aluguel</label>
                            <input type="number" class="form-control" id="rental-days" min="1" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Quantidade</label>
                            <input type="number" class="form-control" id="rental-quantity" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rental-paid">
                            <label class="form-check-label" for="rental-paid" style="font-size:0.875rem;">Pagamento já realizado</label>
                        </div>
                    </div>
                    <div class="value-highlight">
                        <span id="rental-total">R$ 0,00</span>
                        <p>Valor Total do Aluguel</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="save-rental"><i class="bi bi-check2"></i> Registrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Debt -->
<div class="modal fade" id="addDebtModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDebtModalLabel"><i class="bi bi-credit-card me-2"></i>Nova Dívida</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="debt-form">
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label">Pessoa</label>
                            <input type="text" class="form-control" id="debt-person" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" id="debt-date" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <input type="text" class="form-control" id="debt-description" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label">Valor Total (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="debt-total" min="0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Valor Pago (R$)</label>
                            <input type="number" step="0.01" class="form-control" id="debt-paid" min="0" value="0" required>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="debt-is-paid">
                        <label class="form-check-label" for="debt-is-paid" style="font-size:0.875rem;">Dívida quitada</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="save-debt"><i class="bi bi-check2"></i> Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Debt -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cash me-2"></i>Registrar Pagamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="payment-debt-id">
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label">Pessoa</label>
                        <input type="text" class="form-control" id="payment-person" readonly>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Valor Total</label>
                        <input type="text" class="form-control" id="payment-total" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Descrição</label>
                    <input type="text" class="form-control" id="payment-description" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Já Pago</label>
                    <input type="text" class="form-control" id="payment-already-paid" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor do Pagamento (R$)</label>
                    <input type="number" step="0.01" class="form-control" id="payment-amount" min="0" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" id="save-payment"><i class="bi bi-check2-circle"></i> Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Rental -->
<div class="modal fade" id="paymentRentalModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-cash me-2"></i>Pagamento de Aluguel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="payment-rental-id">
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="payment-rental-client" readonly>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Valor Total</label>
                        <input type="text" class="form-control" id="payment-rental-total" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Produto</label>
                    <input type="text" class="form-control" id="payment-rental-product" readonly>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="payment-rental-full" checked>
                        <label class="form-check-label" for="payment-rental-full" style="font-size:0.875rem;">Pagamento total</label>
                    </div>
                </div>
                <div id="partial-payment-container" style="display:none;">
                    <label class="form-label">Valor Parcial (R$)</label>
                    <input type="number" step="0.01" class="form-control" id="payment-rental-amount" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" id="save-rental-payment"><i class="bi bi-check2-circle"></i> Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Return -->
<div class="modal fade" id="returnModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-return-left me-2"></i>Registrar Devolução</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="return-rental-id">
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="return-client" readonly>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Produto</label>
                        <input type="text" class="form-control" id="return-product" readonly>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-4">
                        <label class="form-label">Data</label>
                        <input type="text" class="form-control" id="return-date" readonly>
                    </div>
                    <div class="col-4">
                        <label class="form-label">Dias</label>
                        <input type="text" class="form-control" id="return-days" readonly>
                    </div>
                    <div class="col-4">
                        <label class="form-label">Total</label>
                        <input type="text" class="form-control" id="return-total" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status Pagamento</label>
                    <input type="text" class="form-control" id="return-payment" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-accent" id="confirm-return"><i class="bi bi-check2-circle"></i> Confirmar Devolução</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ── DATABASE ──
const DB = {
    products: JSON.parse(localStorage.getItem('bp_products')) || [],
    rentals:  JSON.parse(localStorage.getItem('bp_rentals'))  || [],
    debts:    JSON.parse(localStorage.getItem('bp_debts'))    || [],
    save() {
        localStorage.setItem('bp_products', JSON.stringify(this.products));
        localStorage.setItem('bp_rentals',  JSON.stringify(this.rentals));
        localStorage.setItem('bp_debts',    JSON.stringify(this.debts));
    },
    nextId: arr => arr.length > 0 ? Math.max(...arr.map(x => x.id)) + 1 : 1
};

// ── NAVIGATION ──
const sectionMap = {
    dashboard: 'dashboard-section',
    products:  'products-section',
    rentals:   'rentals-section',
    returns:   'returns-section',
    debts:     'debts-section',
    reports:   'reports-section'
};

const titleMap = {
    dashboard: 'Dashboard',
    products:  'Produtos',
    rentals:   'Aluguéis',
    returns:   'Devoluções',
    debts:     'Dívidas',
    reports:   'Relatórios'
};

function showSection(name) {
    Object.keys(sectionMap).forEach(k => {
        const el = document.getElementById(sectionMap[k]);
        el.classList.toggle('section-hidden', k !== name);
        document.getElementById(k + '-link').classList.toggle('active', k === name);
    });
    document.getElementById('topbar-title').textContent = titleMap[name];
    if (name === 'reports') renderReportCharts();
}

// ── INIT ──
document.addEventListener('DOMContentLoaded', () => {
    // date
    document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday:'long', day:'numeric', month:'long' });

    Object.keys(sectionMap).forEach(k => {
        document.getElementById(k + '-link').addEventListener('click', e => {
            e.preventDefault();
            showSection(k);
            if (k === 'dashboard') refreshDashboard();
        });
    });

    setupModals();
    loadAll();
    showSection('dashboard');
});

function loadAll() {
    renderProductsTable();
    renderProductDropdown();
    renderRentalsTable();
    renderActiveRentals();
    renderDebtsTable();
    refreshDashboard();
}

// ── DASHBOARD ──
function refreshDashboard() {
    document.getElementById('total-products').textContent = DB.products.length;

    const totalRev = DB.rentals.reduce((s, r) => s + r.valorTotal, 0);
    const paid     = DB.rentals.filter(r => r.pago).reduce((s, r) => s + r.valorTotal, 0);
    document.getElementById('total-revenue').textContent = fmt(totalRev);
    document.getElementById('paid-rentals').textContent  = fmt(paid);
    document.getElementById('unpaid-rentals').textContent= fmt(totalRev - paid);

    const totalDebts = DB.debts.reduce((s, d) => s + d.valorTotal, 0);
    const paidDebts  = DB.debts.reduce((s, d) => s + d.valorPago,  0);
    document.getElementById('total-debts').textContent       = fmt(totalDebts);
    document.getElementById('total-debts-report').textContent= fmt(totalDebts);
    document.getElementById('paid-debts').textContent        = fmt(paidDebts);
    document.getElementById('unpaid-debts').textContent      = fmt(totalDebts - paidDebts);

    document.getElementById('total-rentals').textContent  = fmt(totalRev);
    document.getElementById('final-balance').textContent  = fmt(paid - paidDebts);

    // Recent tables
    const recent5r = DB.rentals.slice().reverse().slice(0,5);
    const tb1 = document.querySelector('#recent-rentals tbody');
    tb1.innerHTML = recent5r.length
        ? recent5r.map(r => `<tr><td>${r.cliente}</td><td>${r.produto}</td><td><span class="badge ${r.pago ? 'badge-paid':'badge-unpaid'}">${r.pago?'Pago':'Aberto'}</span></td></tr>`).join('')
        : `<tr><td colspan="3" class="text-center text-muted py-3" style="font-size:0.82rem;">Nenhum aluguel registrado</td></tr>`;

    const recent5d = DB.debts.slice().reverse().slice(0,5);
    const tb2 = document.querySelector('#recent-debts tbody');
    tb2.innerHTML = recent5d.length
        ? recent5d.map(d => `<tr><td>${d.pessoa}</td><td>${fmt(d.valorTotal)}</td><td><span class="badge ${d.pago ? 'badge-paid':'badge-unpaid'}">${d.pago?'Pago':'Aberto'}</span></td></tr>`).join('')
        : `<tr><td colspan="3" class="text-center text-muted py-3" style="font-size:0.82rem;">Nenhuma dívida registrada</td></tr>`;
}

// ── PRODUCTS ──
function renderProductsTable() {
    const tbody = document.querySelector('#products-table tbody');
    if (!DB.products.length) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="bi bi-tools"></i><p>Nenhum produto cadastrado</p></div></td></tr>`;
        return;
    }
    tbody.innerHTML = DB.products.map(p => `
        <tr>
            <td><strong>${p.nome}</strong></td>
            <td>${p.quantidadeDisponivel}</td>
            <td>${fmt(p.valorDiaria)}</td>
            <td>${fmt(p.quantidadeDisponivel * p.valorDiaria)}</td>
            <td>
                <div class="action-group">
                    <button class="btn-icon btn-icon-edit edit-product" data-id="${p.id}" title="Editar produto"><i class="bi bi-pencil"></i></button>
                    <button class="btn-icon btn-icon-delete delete-product" data-id="${p.id}" title="Excluir produto"><i class="bi bi-trash"></i></button>
                </div>
            </td>
        </tr>
    `).join('');
}

function renderProductDropdown() {
    const sel = document.getElementById('rental-product');
    sel.innerHTML = '<option value="">Selecione um produto</option>';
    DB.products.forEach(p => {
        const o = document.createElement('option');
        o.value = p.nome; o.textContent = p.nome;
        sel.appendChild(o);
    });
}

// ── RENTALS ──
function renderRentalsTable() {
    const tbody = document.querySelector('#rentals-table tbody');
    if (!DB.rentals.length) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><i class="bi bi-cart"></i><p>Nenhum aluguel registrado</p></div></td></tr>`;
        return;
    }
    tbody.innerHTML = DB.rentals.map(a => `
        <tr>
            <td>${a.cliente}</td>
            <td>${a.produto}</td>
            <td>${fmtDate(a.data)}</td>
            <td>${a.dias}</td>
            <td><strong>${fmt(a.valorTotal)}</strong></td>
            <td><span class="badge ${a.pago ? 'badge-paid':'badge-unpaid'}">${a.pago?'Pago':'Aberto'}</span></td>
            <td><span class="badge ${a.devolvido ? 'badge-returned':'badge-rented'}">${a.devolvido?'Devolvido':'Em uso'}</span></td>
            <td>
                <div class="action-group">
                    ${!a.pago ? `<button class="btn-icon btn-icon-pay pay-rental" data-id="${a.id}" title="Registrar pagamento"><i class="bi bi-cash"></i></button>` : ''}
                    ${!a.devolvido ? `<button class="btn-icon btn-icon-return return-rental" data-id="${a.id}" title="Registrar devolução"><i class="bi bi-arrow-return-left"></i></button>` : ''}
                    <button class="btn-icon btn-icon-delete delete-rental" data-id="${a.id}" title="Excluir aluguel"><i class="bi bi-trash"></i></button>
                </div>
            </td>
        </tr>
    `).join('');
    attachRentalEvents('#rentals-table');
}

function renderActiveRentals() {
    const active = DB.rentals.filter(r => !r.devolvido);
    const tbody  = document.querySelector('#active-rentals tbody');
    if (!active.length) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-check2-circle"></i><p>Nenhum aluguel ativo no momento</p></div></td></tr>`;
        return;
    }
    tbody.innerHTML = active.map(a => `
        <tr>
            <td>${a.cliente}</td>
            <td>${a.produto}</td>
            <td>${fmtDate(a.data)}</td>
            <td>${a.dias}</td>
            <td><strong>${fmt(a.valorTotal)}</strong></td>
            <td><span class="badge ${a.pago ? 'badge-paid':'badge-unpaid'}">${a.pago?'Pago':'Aberto'}</span></td>
            <td>
                <div class="action-group">
                    ${!a.pago ? `<button class="btn-icon btn-icon-pay pay-rental" data-id="${a.id}" title="Registrar pagamento"><i class="bi bi-cash"></i></button>` : ''}
                    <button class="btn btn-accent btn-sm return-rental" data-id="${a.id}"><i class="bi bi-arrow-return-left"></i> Devolver</button>
                </div>
            </td>
        </tr>
    `).join('');
    attachRentalEvents('#active-rentals');
}

function attachRentalEvents(tableSelector) {
    document.querySelectorAll(`${tableSelector} .pay-rental`).forEach(btn => {
        btn.addEventListener('click', () => {
            const a = DB.rentals.find(r => r.id === +btn.dataset.id);
            if (a) showPaymentRentalModal(a);
        });
    });
    document.querySelectorAll(`${tableSelector} .return-rental`).forEach(btn => {
        btn.addEventListener('click', () => {
            const a = DB.rentals.find(r => r.id === +btn.dataset.id);
            if (a) showReturnModal(a);
        });
    });
}

// ── DEBTS ──
function renderDebtsTable() {
    const tbody = document.querySelector('#debts-table tbody');
    if (!DB.debts.length) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="bi bi-credit-card"></i><p>Nenhuma dívida registrada</p></div></td></tr>`;
        return;
    }
    tbody.innerHTML = DB.debts.map(d => `
        <tr>
            <td><strong>${d.pessoa}</strong></td>
            <td>${d.descricao}</td>
            <td>${fmtDate(d.data)}</td>
            <td>${fmt(d.valorTotal)}</td>
            <td>${fmt(d.valorPago)}</td>
            <td><span class="badge ${d.pago ? 'badge-paid':'badge-unpaid'}">${d.pago?'Pago':'Aberto'}</span></td>
            <td>
                <div class="action-group">
                    ${!d.pago ? `<button class="btn-icon btn-icon-pay pay-debt" data-id="${d.id}" title="Registrar pagamento"><i class="bi bi-cash"></i></button>` : ''}
                    <button class="btn-icon btn-icon-edit edit-debt" data-id="${d.id}" title="Editar dívida"><i class="bi bi-pencil"></i></button>
                    <button class="btn-icon btn-icon-delete delete-debt" data-id="${d.id}" title="Excluir dívida"><i class="bi bi-trash"></i></button>
                </div>
            </td>
        </tr>
    `).join('');

    document.querySelectorAll('.pay-debt').forEach(btn => {
        btn.addEventListener('click', () => {
            const d = DB.debts.find(x => x.id === +btn.dataset.id);
            if (d) showPaymentModal(d);
        });
    });
}

// ── MODALS ──
function setupModals() {
    // PRODUCT
    document.getElementById('save-product').addEventListener('click', () => {
        const nome    = document.getElementById('product-name').value.trim();
        const qtd     = parseInt(document.getElementById('product-quantity').value);
        const diaria  = parseFloat(document.getElementById('product-daily-rate').value);
        if (!nome || isNaN(qtd) || isNaN(diaria)) return;

        DB.products.push({ id: DB.nextId(DB.products), nome, quantidadeDisponivel: qtd, valorDiaria: diaria });
        DB.save(); loadAll();
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        document.getElementById('product-form').reset();
        toast('Produto adicionado com sucesso!');
    });

    // RENTAL total
    ['rental-product','rental-days','rental-quantity'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateRentalTotal);
        document.getElementById(id).addEventListener('change', updateRentalTotal);
    });
    document.getElementById('rental-product').addEventListener('change', () => {
        const p = DB.products.find(x => x.nome === document.getElementById('rental-product').value);
        document.getElementById('product-info').textContent = p
            ? `Disponível: ${p.quantidadeDisponivel} | Diária: ${fmt(p.valorDiaria)}` : '—';
        updateRentalTotal();
    });

    // SAVE RENTAL
    document.getElementById('save-rental').addEventListener('click', () => {
        const productName = document.getElementById('rental-product').value;
        const product = DB.products.find(p => p.nome === productName);
        const qty = parseInt(document.getElementById('rental-quantity').value);
        const days= parseInt(document.getElementById('rental-days').value);
        const cli = document.getElementById('rental-client').value.trim();
        if (!product || !cli || isNaN(qty) || isNaN(days)) { toast('Preencha todos os campos!','danger'); return; }
        if (product.quantidadeDisponivel < qty) { toast('Quantidade insuficiente!','danger'); return; }

        product.quantidadeDisponivel -= qty;
        DB.rentals.push({
            id: DB.nextId(DB.rentals), cliente: cli, produto: productName,
            dias: days, quantidade: qty, valorDiaria: product.valorDiaria,
            valorTotal: product.valorDiaria * days * qty,
            pago: document.getElementById('rental-paid').checked,
            data: new Date().toISOString(), devolvido: false
        });
        DB.save(); loadAll();
        bootstrap.Modal.getInstance(document.getElementById('addRentalModal')).hide();
        document.getElementById('rental-form').reset();
        toast('Aluguel registrado com sucesso!');
    });

    // SAVE DEBT
    document.getElementById('save-debt').addEventListener('click', saveDivida);

    // SAVE DEBT PAYMENT
    document.getElementById('save-payment').addEventListener('click', () => {
        const id  = +document.getElementById('payment-debt-id').value;
        const d   = DB.debts.find(x => x.id === id);
        const val = parseFloat(document.getElementById('payment-amount').value);
        if (d && val > 0) {
            d.valorPago += val;
            d.pago = d.valorPago >= d.valorTotal;
            DB.save(); loadAll();
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            toast('Pagamento registrado!');
        }
    });

    // RENTAL PAYMENT
    document.getElementById('payment-rental-full').addEventListener('change', function() {
        document.getElementById('partial-payment-container').style.display = this.checked ? 'none' : 'block';
    });
    document.getElementById('save-rental-payment').addEventListener('click', () => {
        const id = +document.getElementById('payment-rental-id').value;
        const a  = DB.rentals.find(x => x.id === id);
        if (a) {
            a.pago = true;
            DB.save(); loadAll();
            bootstrap.Modal.getInstance(document.getElementById('paymentRentalModal')).hide();
            toast('Pagamento registrado!');
        }
    });

    // RETURN
    document.getElementById('confirm-return').addEventListener('click', () => {
        const id = +document.getElementById('return-rental-id').value;
        const a  = DB.rentals.find(x => x.id === id);
        if (a) {
            if (!a.pago && !confirm('Aluguel não pago. Deseja confirmar a devolução mesmo assim?')) return;
            a.devolvido = true;
            const p = DB.products.find(x => x.nome === a.produto);
            if (p) p.quantidadeDisponivel += a.quantidade;
            DB.save(); loadAll();
            bootstrap.Modal.getInstance(document.getElementById('returnModal')).hide();
            toast('Devolução registrada!');
        }
    });

    // REPORT
    document.getElementById('generate-report').addEventListener('click', () => {
        const txt = `Relatório BetoneiraPlus - ${new Date().toLocaleDateString('pt-BR')}
======================================================
Produtos: ${DB.products.length}
Receita Total: ${fmt(DB.rentals.reduce((s,r)=>s+r.valorTotal,0))}
Dívidas: ${fmt(DB.debts.reduce((s,d)=>s+d.valorTotal,0))}

Aluguéis recentes:
${DB.rentals.slice().reverse().slice(0,10).map(r=>`  ${r.cliente} | ${r.produto} | ${fmt(r.valorTotal)} | ${r.pago?'Pago':'Aberto'}`).join('\n')}

Dívidas recentes:
${DB.debts.slice().reverse().slice(0,10).map(d=>`  ${d.pessoa} | ${d.descricao} | ${fmt(d.valorTotal)} | ${d.pago?'Pago':'Aberto'}`).join('\n')}`;

        const blob = new Blob([txt], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `relatorio_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        toast('Relatório gerado!');
    });

    // DELEGATED events
    document.addEventListener('click', e => {
        if (e.target.closest('.edit-product')) {
            const id = +e.target.closest('.edit-product').dataset.id;
            const p  = DB.products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('product-name').value        = p.nome;
            document.getElementById('product-quantity').value    = p.quantidadeDisponivel;
            document.getElementById('product-daily-rate').value  = p.valorDiaria;
            const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
            modal.show();
            const btn = document.getElementById('save-product');
            btn.textContent = 'Atualizar';
            btn.onclick = () => {
                p.nome = document.getElementById('product-name').value;
                p.quantidadeDisponivel = +document.getElementById('product-quantity').value;
                p.valorDiaria = +document.getElementById('product-daily-rate').value;
                DB.save(); loadAll(); modal.hide();
                document.getElementById('product-form').reset();
                toast('Produto atualizado!');
                btn.textContent = 'Salvar';
                btn.onclick = null;
            };
        }
        if (e.target.closest('.delete-product')) {
            const id = +e.target.closest('.delete-product').dataset.id;
            if (confirm('Excluir este produto?')) {
                DB.products = DB.products.filter(p => p.id !== id);
                DB.save(); loadAll(); toast('Produto excluído!');
            }
        }
        if (e.target.closest('.edit-debt')) {
            const id = +e.target.closest('.edit-debt').dataset.id;
            const d  = DB.debts.find(x => x.id === id);
            if (d) openEditDebt(d);
        }
        if (e.target.closest('.delete-debt')) {
            const id = +e.target.closest('.delete-debt').dataset.id;
            if (confirm('Excluir esta dívida?')) {
                DB.debts = DB.debts.filter(d => d.id !== id);
                DB.save(); loadAll(); toast('Dívida excluída!');
            }
        }
        if (e.target.closest('.delete-rental')) {
            const id = +e.target.closest('.delete-rental').dataset.id;
            if (confirm('Excluir este aluguel?')) {
                DB.rentals = DB.rentals.filter(r => r.id !== id);
                DB.save(); loadAll(); toast('Aluguel excluído!');
            }
        }
    });
}

function saveDivida() {
    const d = {
        id: DB.nextId(DB.debts),
        pessoa:     document.getElementById('debt-person').value.trim(),
        descricao:  document.getElementById('debt-description').value.trim(),
        valorTotal: parseFloat(document.getElementById('debt-total').value),
        valorPago:  parseFloat(document.getElementById('debt-paid').value) || 0,
        data:       document.getElementById('debt-date').value || new Date().toISOString(),
        pago:       document.getElementById('debt-is-paid').checked
    };
    if (!d.pessoa) return;
    DB.debts.push(d); DB.save(); loadAll();
    bootstrap.Modal.getInstance(document.getElementById('addDebtModal')).hide();
    document.getElementById('debt-form').reset();
    toast('Dívida registrada!');
}

function openEditDebt(d) {
    document.getElementById('debt-person').value      = d.pessoa;
    document.getElementById('debt-description').value = d.descricao;
    document.getElementById('debt-total').value       = d.valorTotal;
    document.getElementById('debt-paid').value        = d.valorPago;
    document.getElementById('debt-date').value        = d.data.split('T')[0];
    document.getElementById('debt-is-paid').checked   = d.pago;
    document.getElementById('addDebtModalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Dívida';
    const modal = new bootstrap.Modal(document.getElementById('addDebtModal'));
    modal.show();
    const btn = document.getElementById('save-debt');
    btn.textContent = 'Atualizar';
    btn.onclick = () => {
        d.pessoa    = document.getElementById('debt-person').value;
        d.descricao = document.getElementById('debt-description').value;
        d.valorTotal= parseFloat(document.getElementById('debt-total').value);
        d.valorPago = parseFloat(document.getElementById('debt-paid').value);
        d.data      = document.getElementById('debt-date').value;
        d.pago      = document.getElementById('debt-is-paid').checked;
        DB.save(); loadAll(); modal.hide();
        document.getElementById('debt-form').reset();
        document.getElementById('addDebtModalLabel').innerHTML = '<i class="bi bi-credit-card me-2"></i>Nova Dívida';
        toast('Dívida atualizada!');
        btn.textContent = 'Salvar';
        btn.onclick = saveDivida;
    };
}

function showPaymentModal(d) {
    document.getElementById('payment-debt-id').value       = d.id;
    document.getElementById('payment-person').value        = d.pessoa;
    document.getElementById('payment-description').value   = d.descricao;
    document.getElementById('payment-total').value         = fmt(d.valorTotal);
    document.getElementById('payment-already-paid').value  = fmt(d.valorPago);
    document.getElementById('payment-amount').value        = '';
    new bootstrap.Modal(document.getElementById('paymentModal')).show();
}

function showPaymentRentalModal(a) {
    document.getElementById('payment-rental-id').value      = a.id;
    document.getElementById('payment-rental-client').value  = a.cliente;
    document.getElementById('payment-rental-product').value = a.produto;
    document.getElementById('payment-rental-total').value   = fmt(a.valorTotal);
    document.getElementById('payment-rental-amount').value  = '';
    document.getElementById('payment-rental-full').checked  = true;
    document.getElementById('partial-payment-container').style.display = 'none';
    new bootstrap.Modal(document.getElementById('paymentRentalModal')).show();
}

function showReturnModal(a) {
    document.getElementById('return-rental-id').value = a.id;
    document.getElementById('return-client').value    = a.cliente;
    document.getElementById('return-product').value   = a.produto;
    document.getElementById('return-date').value      = fmtDate(a.data);
    document.getElementById('return-days').value      = a.dias;
    document.getElementById('return-total').value     = fmt(a.valorTotal);
    document.getElementById('return-payment').value   = a.pago ? 'Pago' : 'Pendente';
    new bootstrap.Modal(document.getElementById('returnModal')).show();
}

// ── CHARTS ──
let chartR = null, chartD = null;
function renderReportCharts() {
    refreshDashboard();

    const paid   = DB.rentals.filter(r=>r.pago).reduce((s,r)=>s+r.valorTotal,0);
    const unpaid = DB.rentals.filter(r=>!r.pago).reduce((s,r)=>s+r.valorTotal,0);
    const dPaid  = DB.debts.reduce((s,d)=>s+d.valorPago,0);
    const dUnpaid= DB.debts.reduce((s,d)=>s+(d.valorTotal-d.valorPago),0);

    const rcCtx = document.getElementById('rentalsChart').getContext('2d');
    if (chartR) chartR.destroy();
    chartR = new Chart(rcCtx, {
        type: 'doughnut',
        data: { labels:['Recebidos','Em Aberto'], datasets:[{ data:[paid,unpaid], backgroundColor:['#17a86e','#e03c3c'], borderWidth:0 }] },
        options: { responsive:true, plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Aluguéis — Recebido vs Aberto' } } }
    });

    const dcCtx = document.getElementById('debtsChart').getContext('2d');
    if (chartD) chartD.destroy();
    chartD = new Chart(dcCtx, {
        type: 'doughnut',
        data: { labels:['Pagas','Em Aberto'], datasets:[{ data:[dPaid,dUnpaid], backgroundColor:['#17a86e','#f0a500'], borderWidth:0 }] },
        options: { responsive:true, plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Dívidas — Pagas vs Pendentes' } } }
    });
}

// ── HELPERS ──
function updateRentalTotal() {
    const pn  = document.getElementById('rental-product').value;
    const d   = parseInt(document.getElementById('rental-days').value) || 0;
    const q   = parseInt(document.getElementById('rental-quantity').value) || 0;
    const p   = DB.products.find(x => x.nome === pn);
    document.getElementById('rental-total').textContent = p ? fmt(p.valorDiaria * d * q) : 'R$ 0,00';
}

function fmt(v) {
    return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
}

function fmtDate(s) {
    return new Date(s).toLocaleDateString('pt-BR');
}

function toast(msg, type='success') {
    const el = document.createElement('div');
    el.className = `toast-custom ${type}`;
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => { el.style.opacity='0'; el.style.transition='opacity 0.3s'; setTimeout(()=>el.remove(),300); }, 2800);
}
</script>
</body>
</html>
